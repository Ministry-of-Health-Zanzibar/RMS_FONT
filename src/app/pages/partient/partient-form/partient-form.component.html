<div class="p-6 max-w-5xl mx-auto">
  <mat-card class="shadow-lg rounded-2xl">
    <mat-card-header>
      <mat-card-title class="text-2xl font-bold text-gray-800">
        {{ data?.patient ? 'Edit Patient' : 'Add New Patient' }}
      </mat-card-title>
      <mat-card-subtitle class="text-gray-600">
        Please fill in all required details
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="patientForm" (ngSubmit)="onSubmit()" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">

        <!-- Name -->
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Full Name</mat-label>
          <input matInput formControlName="name" placeholder="Enter full name" />
          <mat-error *ngIf="patientForm.get('name')?.hasError('required')">Name is required</mat-error>
        </mat-form-field>

        <!-- Phone -->
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Phone</mat-label>
          <input matInput type="tel" formControlName="phone" maxlength="10" placeholder="Enter 10-digit phone number" />
          <mat-error *ngIf="patientForm.get('phone')?.hasError('required')">Phone number is required</mat-error>
          <mat-error *ngIf="patientForm.get('phone')?.hasError('pattern')">Phone number must be exactly 10 digits</mat-error>
        </mat-form-field>

        <!-- Gender -->
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Gender</mat-label>
          <mat-select formControlName="gender">
            <mat-option value="male">Male</mat-option>
            <mat-option value="female">Female</mat-option>
          </mat-select>
          <mat-error *ngIf="patientForm.get('gender')?.hasError('required')">Gender is required</mat-error>
        </mat-form-field>

        <!-- Matibabu Card -->
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Matibabu Card</mat-label>
          <input matInput formControlName="matibabu_card" maxlength="12" placeholder="Enter card number" />
        </mat-form-field>

        <!-- DOB Type -->
        <div class="col-span-2 flex space-x-4 items-center">
          <label class="font-medium">Date of Birth:</label>
          <mat-radio-group formControlName="dob_type" class="flex space-x-6 items-center">
            <mat-radio-button value="known">Known Date</mat-radio-button>
            <mat-radio-button value="unknown">Estimated Age</mat-radio-button>
          </mat-radio-group>
        </div>

        <!-- Date or Age -->
        <mat-form-field appearance="outline" *ngIf="patientForm.get('dob_type')?.value === 'known'" class="w-full">
          <mat-label>Date of Birth</mat-label>
          <input matInput [matDatepicker]="dobPicker" formControlName="date_of_birth" />
          <mat-datepicker-toggle matSuffix [for]="dobPicker"></mat-datepicker-toggle>
          <mat-datepicker #dobPicker></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline" *ngIf="patientForm.get('dob_type')?.value === 'unknown'" class="w-full">
          <mat-label>Estimated Age</mat-label>
          <input matInput type="number" formControlName="date_of_birth" placeholder="Enter estimated age" />
        </mat-form-field>

        <!-- Job -->
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Job</mat-label>
          <input matInput formControlName="job" placeholder="Enter job" />
        </mat-form-field>

        <!-- Position -->
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Position</mat-label>
          <input matInput formControlName="position" placeholder="Enter position" />
        </mat-form-field>

        <!-- Location -->
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Location</mat-label>
          <input matInput placeholder="Search location" formControlName="location_id" [matAutocomplete]="auto" />
          <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayFn">
            <mat-option *ngFor="let option of filteredOptions | async" [value]="option">
              {{ option.label }}
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>

        <!-- ZanID -->
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>ZanID</mat-label>
          <input matInput formControlName="zan_id" maxlength="9" placeholder="Enter ZanID" />
        </mat-form-field>

   <mat-form-field appearance="outline" class="w-full">
    <mat-label>Upload Patient File</mat-label>

    <input
      matInput
      type="text"
      formControlName="patient_file"
      readonly
      placeholder="No file chosen"
      (click)="fileInput.click()"
    />

    <input
      type="file"
      accept=".pdf,.doc,.docx,.jpg,.png"
      hidden
      #fileInput
      (change)="onAttachmentSelected($event)"
    />

    <mat-icon matSuffix style="cursor: pointer" (click)="fileInput.click()">
      attach_file
    </mat-icon>

    <mat-error
      *ngIf="
        patientForm.get('patient_file')?.invalid &&
        patientForm.get('patient_file')?.touched
      "
    >
      File is required
    </mat-error>
  </mat-form-field>


        <!-- Insurance -->
        <div class="col-span-2">
          <label class="font-medium block mb-2">Do you have insurance?</label>
          <mat-radio-group formControlName="has_insurance" class="flex space-x-6 items-center">
            <mat-radio-button [value]="true">Yes</mat-radio-button>
            <mat-radio-button [value]="false">No</mat-radio-button>
          </mat-radio-group>
        </div>

        <div *ngIf="patientForm.get('has_insurance')?.value === true" class="col-span-2 grid grid-cols-1 md:grid-cols-3 gap-4">
          <mat-form-field appearance="outline">
            <mat-label>Insurance Provider</mat-label>
            <mat-select formControlName="insurance_provider_name">
              <mat-option value="ZSSF">ZSSF</mat-option>
              <mat-option value="NHIF">NHIF</mat-option>
              <mat-option value="Other">Other</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Card Number</mat-label>
            <input matInput formControlName="card_number" maxlength="10" placeholder="Enter card number" />
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Valid Until</mat-label>
            <input matInput [matDatepicker]="picker" formControlName="valid_until" />
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
          </mat-form-field>
        </div>

        <!-- File Upload -->



        <!-- Existing file -->
        <div *ngIf="currentFileName" class="col-span-2">
          Current File: <a [href]="currentFilePath" target="_blank">{{ currentFileName }}</a>
        </div>

        <!-- Actions -->
        <div class="col-span-2 flex justify-end space-x-3 mt-6">
          <button mat-stroked-button color="warn" type="button" (click)="onCancel()">Cancel</button>
          <button mat-raised-button color="primary" type="submit" [disabled]="loading || !patientForm.valid">
            <span *ngIf="loading">
              <mat-spinner diameter="20"></mat-spinner> Processing...
            </span>
            <span *ngIf="!loading">Save</span>
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</div>
