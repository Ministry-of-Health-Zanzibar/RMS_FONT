<div class="p-6 w-full h-full">
  <mat-card class="w-full shadow-lg rounded-2xl">
    <mat-card-content>
      <form [formGroup]="patientForm" (ngSubmit)="onSubmit()">
        <mat-horizontal-stepper linear #stepper>
          
          <mat-step [stepControl]="patientForm.get('basicInfo')">
            <div formGroupName="basicInfo">
              <ng-template matStepLabel>Patient Information</ng-template>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                
                <mat-form-field appearance="outline">
                  <mat-label>Matibabu Card</mat-label>
                  <input matInput formControlName="matibabu_card" maxlength="12" (keypress)="allowOnlyNumbers($event)" />
                  <mat-error *ngIf="patientForm.get('basicInfo.matibabu_card')?.hasError('required')">Required</mat-error>
                  <mat-error *ngIf="patientForm.get('basicInfo.matibabu_card')?.hasError('pattern')">12 digits required</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Full Name *</mat-label>
                  <input matInput formControlName="name" />
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Date of Birth *</mat-label>
                  <input matInput [matDatepicker]="dobPicker" formControlName="date_of_birth" placeholder="DD/MM/YYYY" />
                  <mat-datepicker-toggle matIconSuffix [for]="dobPicker"></mat-datepicker-toggle>
                  <mat-datepicker #dobPicker></mat-datepicker>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Gender *</mat-label>
                  <mat-select formControlName="gender">
                    <mat-option value="Male">Male</mat-option>
                    <mat-option value="Female">Female</mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Phone</mat-label>
                  <input matInput formControlName="phone" />
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Location</mat-label>
                  <input type="text" matInput formControlName="location_id" [matAutocomplete]="auto" />
                  <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayLocation.bind(this)">
                    <mat-option *ngFor="let option of filteredOptions | async" [value]="option.location_id">
                      {{ option.label }}
                    </mat-option>
                  </mat-autocomplete>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Job</mat-label>
                  <input matInput formControlName="job" />
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Position</mat-label>
                  <input matInput formControlName="position" />
                </mat-form-field>
              </div>
              
              <div class="flex justify-end mt-6">
                <button type="button" mat-raised-button color="primary" matStepperNext>Next</button>
              </div>
            </div>
          </mat-step>

          <mat-step [stepControl]="patientForm.get('historyInfo')">
            <div formGroupName="historyInfo">
              <ng-template matStepLabel>Patient History</ng-template>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                
                <mat-form-field appearance="outline">
                  <mat-label>Reason *</mat-label>
                  <mat-select formControlName="reason_id">
                    <mat-option *ngFor="let reason of reasonList" [value]="reason.reason_id">
                      {{ reason.referral_reason_name }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Diagnosis</mat-label>
                  <mat-select formControlName="diagnosis_ids" multiple>
                    <mat-option *ngFor="let diag of diagnosesList" [value]="diag.diagnosis_id">
                      {{ diag.diagnosis_name }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Case Type</mat-label>
                  <mat-select formControlName="case_type">
                    <mat-option value="Emergency">Emergency</mat-option>
                    <mat-option value="Routine">Routine</mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>File Number</mat-label>
                  <input matInput formControlName="file_number" />
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Referring Date</mat-label>
                  <input matInput [matDatepicker]="refDate" formControlName="referring_date" />
                  <mat-datepicker-toggle matIconSuffix [for]="refDate"></mat-datepicker-toggle>
                  <mat-datepicker #refDate></mat-datepicker>
                </mat-form-field>

                <mat-form-field appearance="outline" class="col-span-2">
                  <mat-label>History of Presenting Illness</mat-label>
                  <textarea matInput rows="3" formControlName="history_of_presenting_illness"></textarea>
                </mat-form-field>

                <div class="col-span-2">
                  <label class="block mb-2 font-medium">Upload History File</label>
                  <input type="file" (change)="onFileSelected($event)" class="text-sm" />
                </div>
              </div>

              <div class="flex justify-between mt-6">
                <button type="button" mat-button matStepperPrevious>Back</button>
                <button type="button" mat-raised-button color="primary" matStepperNext>Next</button>
              </div>
            </div>
          </mat-step>

          <mat-step [stepControl]="patientForm.get('insuranceInfo')">
            <div formGroupName="insuranceInfo">
              <ng-template matStepLabel>Insurance</ng-template>
              <div class="mt-4">
                <label class="block mb-2 font-medium">Do you have insurance?</label>
                <mat-radio-group formControlName="has_insurance" class="flex gap-4">
                  <mat-radio-button [value]="true">Yes</mat-radio-button>
                  <mat-radio-button [value]="false">No</mat-radio-button>
                </mat-radio-group>
              </div>

              <div *ngIf="patientForm.get('insuranceInfo.has_insurance')?.value" class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                <mat-form-field appearance="outline">
                  <mat-label>Provider</mat-label>
                  <input matInput formControlName="insurance_provider_name" />
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>Card Number</mat-label>
                  <input matInput formControlName="card_number" />
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>Valid Until</mat-label>
                  <input matInput [matDatepicker]="insDate" formControlName="valid_until" />
                  <mat-datepicker-toggle matIconSuffix [for]="insDate"></mat-datepicker-toggle>
                  <mat-datepicker #insDate></mat-datepicker>
                </mat-form-field>
              </div>

              <div class="flex justify-between mt-6">
                <button type="button" mat-button matStepperPrevious>Back</button>
                <button type="submit" mat-raised-button color="primary" [disabled]="loading">
                  {{ loading ? "Saving..." : "Save Patient" }}
                </button>
              </div>
            </div>
          </mat-step>
        </mat-horizontal-stepper>
      </form>
    </mat-card-content>
  </mat-card>
</div>