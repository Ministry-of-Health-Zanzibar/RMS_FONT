<div class="form-container">
  <div class="w-full">
    <div class="relative h-full rounded-lg group p-6">
      <!-- Title -->
      <div class="font-semibold" *ngIf="!patientData">
        CREATE NEW MEDICAL BOARD DOCUMENT
      </div>
      <div class="font-semibold" *ngIf="patientData">
        UPDATE BOARD LIST DOCUMENT
      </div>

      <!-- Form -->
      <form
        [formGroup]="patientForm"
        class="horizontal-form"
        enctype="multipart/form-data"
      >
        <!-- Board Type -->
        <div class="form-row">
          <mat-form-field class="form-field w-full">
            <mat-label>Board Type</mat-label>
            <mat-select formControlName="board_type">
              <mat-option value="Emergency">Emergency</mat-option>
              <mat-option value="Routine">Routine</mat-option>
            </mat-select>
            <mat-error
              *ngIf="
                patientForm.get('board_type')?.invalid &&
                patientForm.get('board_type')?.touched
              "
            >
              Board type is required
            </mat-error>
          </mat-form-field>
        </div>


        <!-- Board Date -->
        <div class="form-row">
          <mat-form-field class="form-field w-full">
            <mat-label>Board Date</mat-label>
            <input
              matInput
              [matDatepicker]="picker"
              formControlName="board_date"
              placeholder="Select Date"
            />
            <mat-datepicker-toggle
              matSuffix
              [for]="picker"
            ></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
            <mat-error
              *ngIf="
                patientForm.get('board_date')?.invalid &&
                patientForm.get('board_date')?.touched
              "
            >
              Board date is required
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Number of Patients -->
        <div class="form-row">
          <mat-form-field class="form-field w-full">
            <mat-label>Number of Patients</mat-label>
            <input
              matInput
              type="number"
              formControlName="no_of_patients"
              placeholder="Enter number"
            />
            <mat-error
              *ngIf="
                patientForm.get('no_of_patients')?.invalid &&
                patientForm.get('no_of_patients')?.touched
              "
            >
              Must be at least 1
            </mat-error>
          </mat-form-field>
        </div>

        <!-- File Upload -->
        <div class="form-row">
          <mat-form-field class="form-field w-full">
            <mat-label>Upload Medical Board File</mat-label>
            <input
              matInput
              type="text"
              formControlName="patient_list_file"
              readonly
              placeholder="No file chosen"
              (click)="fileInput.click()"
            />

            <input
              type="file"
              accept=".pdf,.doc,.docx,.jpg,.png"
              hidden
              #fileInput
              (change)="onAttachmentSelected($event)"
            />
            <mat-icon
              matSuffix
              style="cursor: pointer"
              (click)="fileInput.click()"
              >attach_file</mat-icon
            >
            <!-- <mat-error
              *ngIf="
                patientForm.get('patient_list_file')?.invalid &&
                patientForm.get('patient_list_file')?.touched
              "
            >
              File is required
            </mat-error> -->
          </mat-form-field>
        </div>
        <!-- User Selection -->
<div class="form-row">
  <mat-form-field class="form-field w-full">
    <mat-label>Select Medical Board Members</mat-label>
    <mat-select
      multiple
      (selectionChange)="onUserSelected($event)"
      (openedChange)="onUserDropdownOpened()"
    >
      <!-- ðŸ”„ Show loader if fetching users -->
      <mat-option *ngIf="isLoadingUsers" disabled>
        <mat-progress-spinner
          diameter="24"
          mode="indeterminate"
        ></mat-progress-spinner>
        &nbsp;Loading users...
      </mat-option>

      <!-- ðŸ” Search box appears only if users exist -->
      <ng-container *ngIf="!isLoadingUsers && userList.length > 0">
        <mat-option>
          <input
            matInput
            placeholder="Search user..."
            [(ngModel)]="userSearch"
            (ngModelChange)="filterUser()"
            class="w-full px-2 py-1 text-sm border rounded-md"
          />
        </mat-option>

        <!-- ðŸ‘¤ Show filtered users -->
        <mat-option
          *ngFor="let u of filteredUser"
          [value]="u.user_id"
        >
          {{ u.full_name }}
        </mat-option>

        <!-- ðŸš« Show message if no match -->
        <mat-option *ngIf="filteredUser.length === 0" disabled>
          No users found
        </mat-option>
      </ng-container>

      <!-- ðŸš« Show message if API returned empty -->
      <mat-option *ngIf="!isLoadingUsers && userList.length === 0" disabled>
        No users available
      </mat-option>
    </mat-select>

    <mat-error
      *ngIf="patientForm.get('user_id')?.invalid && patientForm.get('user_id')?.touched"
    >
      Please select at least one user
    </mat-error>
  </mat-form-field>
</div>


      </form>

    <mat-dialog-actions align="end">
  <button mat-button (click)="onClose()" [disabled]="loading">Cancel</button>

  <!-- Save/Update Button -->
  <button
    *ngIf="!loading"
    mat-flat-button
    color="primary"
    [disabled]="patientForm.invalid"
    (click)="patientData ? updatePatient() : savePatient()"
  >
    {{ patientData ? "Update" : "Save" }}
  </button>

  <!-- Spinner while saving -->
  <mat-progress-spinner
    *ngIf="loading"
    diameter="28"
    mode="indeterminate"
  ></mat-progress-spinner>
</mat-dialog-actions>

    </div>
  </div>
</div>
