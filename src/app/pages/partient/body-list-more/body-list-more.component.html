<div class="max-w-7xl mx-auto p-6">
  <!-- Body List Table -->
  <div
    *ngIf="bodyListDataSource"
    class="bg-white shadow-xl rounded-2xl overflow-hidden p-6 mb-6"
  >
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold">Body List Info</h2>
    </div>

    <table class="w-full table-auto border-collapse">
      <thead class="bg-gray-200 text-gray-700">
        <tr>
          <th class="border border-gray-300 p-3 text-center">Body Title</th>
          <th class="border border-gray-300 p-3 text-center">File</th>
          <th class="border border-gray-300 p-3 text-center">Actions</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let file of bodyListDataSource.filteredData">
          <!-- Body Title -->
          <td
            class="border border-gray-300 p-3 text-center font-medium text-gray-700"
          >
            {{ file.patient_list_title }}
          </td>

          <!-- PDF Link -->
          <td class="border border-gray-300 p-3 text-center">
            <a
                *ngIf="file?.patient_list_file"
                (click)="viewPDF(file)"
                class="inline-flex items-center gap-1 text-indigo-600 hover:text-indigo-800 cursor-pointer"
              >
                <mat-icon>picture_as_pdf</mat-icon> View PDF
              </a>
          </td>

          <!-- Action Button -->
          <td class="border border-gray-300 p-3 text-center">
            <span
              (click)="addPatient(file.patient_list_id)"
              *ngIf="permission.parmissionMatched(['View Patient List'])"
              matTooltip="Add Bill"
              class="cursor-pointer w-10 h-10 flex items-center justify-center text-white bg-blue-600 rounded-full hover:bg-blue-700 transition-all mx-auto"
            >
              <mat-icon>person_add</mat-icon>
            </span>
          </td>
        </tr>

        <!-- No Data Row -->
        <tr *ngIf="bodyListDataSource.filteredData.length === 0">
          <td
            colspan="4"
            class="border border-gray-300 p-3 text-center text-gray-500"
          >
            No Body List Available
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Patients Table -->
  <div class="bg-white shadow-xl rounded-2xl p-6 mb-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold">Patients List</h2>
      <mat-form-field appearance="fill">
        <mat-label>Filter Patients</mat-label>
        <input
          matInput
          (keyup)="applyPatientFilter($event)"
          placeholder="Filter..."
        />
      </mat-form-field>
    </div>

    <table mat-table [dataSource]="patientDataSource" matSort class="min-w-full">
      <!-- Patient ID -->
      <ng-container matColumnDef="matibabu_card">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>
        Matibabu Card ID
      </th>
      <td mat-cell *matCellDef="let p">
        <span class="text-blue-600 font-medium">
          {{ p.matibabu_card ?? 'N/A' }}
        </span>
      </td>
    </ng-container>



      <!-- Patient Name -->
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Patient Name</th>
        <td mat-cell *matCellDef="let p">{{ p.name | uppercase }}</td>
      </ng-container>

      <!-- Gender -->
      <ng-container matColumnDef="gender">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Gender</th>
        <td mat-cell *matCellDef="let p">{{ p.gender | uppercase}}</td>
      </ng-container>

      <!-- Phone -->
      <ng-container matColumnDef="phone">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Phone Number</th>
        <td mat-cell *matCellDef="let p">{{ p.phone }}</td>
      </ng-container>

      <!-- Location -->
      <ng-container matColumnDef="location">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Location</th>
        <td mat-cell *matCellDef="let p">{{ p.location }}</td>
      </ng-container>

  <!-- Files -->
<ng-container matColumnDef="files">
  <th mat-header-cell *matHeaderCellDef mat-sort-header>Files</th>
  <td mat-cell *matCellDef="let p">
    <ng-container *ngIf="p.files?.length > 0; else noFiles">
      <div *ngFor="let f of p.files" class="flex items-center gap-3">
        <!-- PDF View Button -->
        <a
          [href]="documentUrl + f.file_path"
          target="_blank"
          class="inline-flex items-center gap-1 text-indigo-600 hover:text-indigo-800 cursor-pointer"
        >
          <mat-icon>picture_as_pdf</mat-icon>
          View PDF
        </a>

        <!-- Add Medical History Button -->
       <button
  mat-flat-button
  color="primary"
  class="!bg-green-600 !text-white !px-2 !py-1 rounded-md hover:!bg-green-700 transition"
  (click)="openAddMedicalHistory(p)"
  matTooltip="Add Medical History"
>
  <mat-icon class="!text-white text-base">note_add</mat-icon>
</button>

      </div>
    </ng-container>

    <ng-template #noFiles>
      <span class="text-gray-400">N/A</span>
      <!-- Still allow adding history even if no file -->
     <button
      mat-icon-button
      color="primary"
      class="!bg-green-600 !text-white !ml-3 hover:!bg-green-700 transition"
      (click)="openAddMedicalHistory(p)"
      matTooltip="Add Medical History"
    >
      <mat-icon class="!text-white">add</mat-icon>
    </button>

    </ng-template>
  </td>
</ng-container>

      <!-- Rows -->
      <tr mat-header-row *matHeaderRowDef="displayedPatientColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedPatientColumns"></tr>
    </table>

    <mat-paginator
      #patientPaginator
      [pageSizeOptions]="[5, 10, 20]"
      showFirstLastButtons
    ></mat-paginator>
  </div>
</div>
