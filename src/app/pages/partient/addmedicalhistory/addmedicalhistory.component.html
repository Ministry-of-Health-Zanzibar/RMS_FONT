<div class="p-6 bg-white rounded-lg shadow-md w-[800px] mx-auto">
  <h2 class="text-lg font-semibold mb-6 text-center">Add Medical History</h2>

  <form [formGroup]="medicalForm" (ngSubmit)="onSubmit()" class="space-y-4">
    <p class="text-xs text-gray-500">
      Patient ID: {{ medicalForm.get('patient_id')?.value }}
    </p>

    <!-- First Row -->
    <div class="grid grid-cols-2 gap-4">
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Referring Doctor</mat-label>
        <input
          matInput
          formControlName="referring_doctor"
          placeholder="Enter doctor's name"
        />
      </mat-form-field>

      <mat-form-field appearance="outline" class="w-full">
        <mat-label>File Number</mat-label>
        <input
          matInput
          formControlName="file_number"
          placeholder="Enter file number"
        />
      </mat-form-field>
    </div>

    <!-- Second Row -->
    <div class="grid grid-cols-2 gap-4">
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Referring Date</mat-label>
        <input
          matInput
          [matDatepicker]="picker"
          formControlName="referring_date"
          placeholder="Select date"
        />
        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-datepicker #picker></mat-datepicker>

        <!-- Frontend Validation -->
        <mat-error *ngIf="medicalForm.get('referring_date')?.hasError('required')">
          Referring date is required
        </mat-error>

        <!-- Backend Validation -->
        <mat-error *ngIf="backendErrors?.referring_date">
          {{ backendErrors.referring_date[0] }}
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="w-full">
        <mat-label>History of Presenting Illness</mat-label>
        <textarea
          matInput
          rows="3"
          formControlName="history_of_presenting_illness"
        ></textarea>
      </mat-form-field>
    </div>

    <!-- Reason Row -->
    <div class="grid grid-cols-2 gap-4">
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Reason</mat-label>
        <mat-select formControlName="reason_id">
          <mat-option *ngFor="let reason of reasonList" [value]="reason.reason_id">
            {{ reason.referral_reason_name }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Physical Findings</mat-label>
        <textarea
          matInput
          rows="3"
          formControlName="physical_findings"
        ></textarea>
      </mat-form-field>
    </div>

    <!-- Investigations + Management -->
    <div class="grid grid-cols-2 gap-4">
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Investigations</mat-label>
        <textarea matInput rows="3" formControlName="investigations"></textarea>
      </mat-form-field>

      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Management Done</mat-label>
        <textarea matInput rows="3" formControlName="management_done"></textarea>
      </mat-form-field>
    </div>

    <!-- Board Comments -->
    <div class="grid grid-cols-1">
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Board Comments</mat-label>
        <textarea matInput rows="3" formControlName="board_comments"></textarea>
      </mat-form-field>
    </div>

    <!-- Diagnoses Section -->
    <div>
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Select Diagnoses</mat-label>
        <mat-select
          formControlName="diagnosis_ids"
          multiple
          (openedChange)="onDiagnosesDropdownOpened()"
        >
          <!-- Search Input Inside Dropdown -->
          <mat-option>
            <input
              matInput
              placeholder="Search diagnoses..."
              [(ngModel)]="diagnosisSearch"
              (keyup)="filterDiagnoses()"
              class="w-full px-2 py-1 border border-gray-300 rounded"
            />
          </mat-option>

          <!-- Filtered Diagnoses -->
          <mat-option
            *ngFor="let d of filteredDiagnoses"
            [value]="d.diagnosis_id"
          >
            {{ d.diagnosis_name }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <!-- File Upload -->
    <div>
      <label class="block mb-2 text-sm font-medium">Upload History File</label>
      <input type="file" (change)="onFileSelected($event)" />
      <p *ngIf="selectedFile" class="text-sm text-gray-500 mt-1">
        Selected: {{ selectedFile.name }}
      </p>
    </div>

    <!-- Buttons -->
    <div class="flex justify-end gap-3 pt-2">
      <button mat-stroked-button type="button" (click)="onCancel()">Cancel</button>
      <button mat-flat-button color="primary" type="submit" [disabled]="loading">
        <mat-spinner *ngIf="loading" diameter="20" strokeWidth="3"></mat-spinner>
        <span *ngIf="!loading">Save</span>
      </button>
    </div>
  </form>
</div>
