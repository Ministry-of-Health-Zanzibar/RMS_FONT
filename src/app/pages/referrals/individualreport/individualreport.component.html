<button mat-raised-button color="primary" (click)="downloadReport()">
  <mat-icon>download</mat-icon>
  Download Report
</button>

<div id="print-area">
<div class="letter-header">
  <div class="logo-container">
  <img src="../../../../assets/img/smz.png" class="logo" alt="Logo" />
</div>


  <h2>SERIKALI YA MAPINDUZI YA ZANZIBAR</h2>
  <h3>WIZARA YA AFYA</h3>

  <div class="header-line"></div>

  <p class="ref">
    <b>Individual Referral Report</b><br />
    Referral No: {{ referral.referral_number }}
  </p>
</div>

<div class="two-column">

  <!-- PATIENT -->
  <div class="column">
    <h4>Patient Information</h4>
    <table class="info-table">
      <tr><td>Name:</td><td>{{ referral.patient.name }}</td></tr>
      <tr><td>Gender:</td><td>{{ referral.patient.gender }}</td></tr>
      <tr><td>Date of Birth:</td><td>{{ referral.patient.date_of_birth }}</td></tr>
      <tr><td>Phone:</td><td>{{ referral.patient.phone }}</td></tr>
      <tr><td>Location:</td><td>{{ referral.patient.geographical_location?.label }}</td></tr>
    </table>
  </div>

  <!-- HOSPITAL -->
  <div class="column">
    <h4>Hospital Information</h4>
    <table class="info-table">
      <tr><td>Hospital:</td><td>{{ referral.hospital.hospital_name }}</td></tr>
      <tr><td>Code:</td><td>{{ referral.hospital.hospital_code }}</td></tr>
      <tr><td>Address:</td><td>{{ referral.hospital.hospital_address }}</td></tr>
    </table>
  </div>

</div>

<h4 class="section-title">Medical History</h4>

<div *ngFor="let h of referral.patient.patient_histories" class="paragraph">
  <p><b>Referring Doctor:</b> {{ h.referring_doctor }}</p>
  <p><b>Presenting Illness:</b> {{ h.history_of_presenting_illness }}</p>
  <p><b>Investigations:</b> {{ h.investigations }}</p>
  <p><b>Management Done:</b> {{ h.management_done }}</p>
</div>

<h4 class="section-title">Hospital (Doctor) Assessment</h4>

<!-- REFERRAL REASON -->
<p *ngIf="referral.patient.patient_histories[0]?.reason">
  <b>Referral Reason:</b><br />
  {{ referral.patient.patient_histories[0]?.reason?.referral_reason_name }}
  <br />
  <span class="muted">
    {{ referral.patient.patient_histories[0]?.reason?.reason_descriptions }}
  </span>
</p>

<!-- DOCTOR DIAGNOSES -->
<table class="data-table"
       *ngIf="referral.patient.patient_histories[0]?.diagnoses?.length">
  <tr>
    <th>#</th>
    <th>Diagnosis Code</th>
    <th>Diagnosis Name</th>
  </tr>

  <tr *ngFor="let d of referral.patient.patient_histories[0]?.diagnoses; let i = index">
    <td>{{ i + 1 }}</td>
    <td>{{ d.diagnosis_code }}</td>
    <td>{{ d.diagnosis_name }}</td>
  </tr>
</table>

<p *ngIf="!referral.patient.patient_histories[0]?.diagnoses?.length"
   class="muted">
  No hospital diagnoses recorded.
</p>

<h4 class="section-title">Medical Board Assessment</h4>

<!-- BOARD DECISION / REASON -->
<p *ngIf="referral.patient.patient_histories[0]?.board_reason">
  <b>Board Decision / Reason:</b><br />
  {{ referral.patient.patient_histories[0]?.board_reason?.referral_reason_name }}
  <br />
  <span class="muted">
    {{ referral.patient.patient_histories[0]?.board_reason?.reason_descriptions }}
  </span>
</p>

<!-- BOARD DIAGNOSES -->
<table class="data-table"
       *ngIf="referral.patient.patient_histories[0]?.board_diagnoses?.length">
  <tr>
    <th>#</th>
    <th>Diagnosis Code</th>
    <th>Diagnosis Name</th>
  </tr>

  <tr *ngFor="let d of referral.patient.patient_histories[0]?.board_diagnoses; let i = index">
    <td>{{ i + 1 }}</td>
    <td>{{ d.diagnosis_code }}</td>
    <td>{{ d.diagnosis_name }}</td>
  </tr>
</table>

<p *ngIf="!referral.patient.patient_histories[0]?.board_diagnoses?.length"
   class="muted">
  No board diagnoses recorded.
</p>

<h4 class="section-title">Follow-Up Information</h4>

<table class="data-table" *ngIf="referral?.patient?.followups?.length">
  <tr>
    <th>#</th>
    <th>Follow-Up Date</th>
    <th>Status</th>
    <th>Notes</th>
  </tr>

  <tr *ngFor="let f of referral.patient.followups; let i = index">
    <td>{{ i + 1 }}</td>
    <td>{{ f.followup_date | date:'longDate' }}</td>
    <td>{{ f.followup_status }}</td>
    <td>{{ f.notes }}</td>
  </tr>
</table>

<p *ngIf="!referral?.patient?.followups?.length" class="muted">
  No follow-up records available.
</p>

<h4 class="section-title">Billing Summary</h4>

<div *ngFor="let bill of referral.bills">
  <p>
    <b>Billing Period:</b>
    {{ bill.bill_period_start | date }} – {{ bill.bill_period_end | date }}
  </p>

  <p><b>Total Amount:</b> {{ bill.total_amount | number }} TZS</p>
  <p><b>Status:</b> {{ bill.bill_status }}</p>

  <table class="data-table" *ngIf="bill.bill_items?.length">
    <tr>
      <th>Description</th>
      <th>Amount (TZS)</th>
    </tr>
    <tr *ngFor="let item of bill.bill_items">
      <td>{{ item.description }}</td>
      <td>{{ item.amount | number }}</td>
    </tr>
  </table>
</div>



<h4 class="section-title">Payments Information</h4>

<!-- SUMMARY -->
<table class="info-table">
  <tr>
    <td><b>Total Bill Amount:</b></td>
    <td>{{ getTotalBillAmount() | number }} TZS</td>
  </tr>
  <tr>
    <td><b>Total Amount Paid:</b></td>
    <td>{{ getTotalPaidAmount() | number }} TZS</td>
  </tr>
  <tr>
    <td><b>Outstanding Balance:</b></td>
    <td>{{ getRemainingAmount() | number }} TZS</td>
  </tr>
</table>

<br />

<!-- DETAILED PAYMENTS -->
<div *ngFor="let bill of referral.bills">

  <p>
    <b>Billing Period:</b>
    {{ bill.bill_period_start | date }} –
    {{ bill.bill_period_end | date }}
  </p>

  <table class="data-table" *ngIf="bill.payments?.length">
    <tr>
      <th>Payer</th>
      <th>Amount (TZS)</th>
      <th>Payment Method</th>
      <th>Reference</th>
      <th>Date</th>
      <th>Status</th>
    </tr>

    <tr *ngFor="let p of bill.payments">
      <td>{{ p.payer }}</td>
      <td>
        {{ p.pivot?.allocated_amount || p.amount_paid | number }}
      </td>
      <td>{{ p.payment_method }}</td>
      <td>{{ p.reference_number }}</td>
      <td>{{ p.payment_date | date:'mediumDate' }}</td>
      <td>{{ p.pivot?.status }}</td>
    </tr>
  </table>

  <p *ngIf="!bill.payments?.length" class="muted">
    No payments recorded for this billing period.
  </p>

  <br />
</div>


<div class="signature-section">
  <p><b>Confirmed By:</b></p>
  <p>
    {{ referral.confirmed_by?.first_name }}
    {{ referral.confirmed_by?.last_name }}
  </p>

  <p><b>Date:</b> {{ referral.updated_at | date:'longDate' }}</p>

  <br />

  <p>______________________________</p>
  <p><i>Authorized Signature</i></p>
</div>

<div class="letter-footer">
  <div class="footer-left">
    <p>6 Barabara ya Health Office, S.L.P 236 MNANZIMMOJA</p>
    <p>POSTIKODI: 70467 Mjini Magharibi Zanzibar</p>
  </div>

  <div class="footer-right">
    <p>
      Tovuti:
      <a href="http://www.mohz.go.tz" target="_blank">
        www.mohz.go.tz
      </a>
    </p>
    <p>
      Barua pepe:
      <a href="mailto:{{ email || 'N/A' }}">
        {{ email || 'N/A' }}
      </a>
    </p>
  </div>
</div>


</div>